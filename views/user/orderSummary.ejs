<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Summary</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .header { background-color: #f4a261; color: white; padding: 10px; text-align: center; }
        .summary { background-color: #fff; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .summary div { margin-bottom: 10px; }
        .total { font-weight: bold; color: #2a9d8f; }
        .continue-btn { background-color: #264653; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <h2>ORDER SUMMARY</h2>
    </div>
    <div class="summary">
        <div>SU FROM SO</div>
        <div><strong>Show Date & Time :</strong> <%= date %>, <%= time %></div>
        <div><strong>Screen :</strong> <%= screen %></div>
        <div><strong>Seats :</strong> <%= selectedSeats.join(', ') %></div>
        <div><strong><%= selectedSeats.length %> Ticket</strong> <span class="total">₹<%= totalAmount %> ✓</span></div>
        <div class="total">₹<%= totalAmount %></div>
        <button class="continue-btn" id="payBtn">CONTINUE</button>
    </div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// document.getElementById("payBtn").onclick = async function () {
//     const amount = <%= totalAmount %>;

//     const orderData = await fetch("/create-order", {
//         method: "POST",
//         headers: { "Content-Type": "application/json" },
//         body: JSON.stringify({ amount })
//     }).then(res => res.json());

//     if (!orderData.id) {
//         Swal.fire({
//             icon: 'error',
//             title: 'Failed to create Razorpay order',
//             text: 'Please try again later.'
//         });
//         return;
//     }

//     const options = {
//         key: "<%= razorpayKeyId %>", // passed from backend render
//         amount: orderData.amount,
//         currency: "INR",
//         name: "Your Cinema",
//         description: "Ticket Payment",
//         order_id: orderData.id,
//         handler: async function (response) {
//             const verifyRes = await fetch("/verify-payment", {
//                 method: "POST",
//                 headers: { "Content-Type": "application/json" },
//                 body: JSON.stringify(response)
//             }).then(res => res.json());

//             if (verifyRes.success) {
//                 Swal.fire({
//                     icon: 'success',
//                     title: 'Payment successful!',
//                     text: 'Thank you for your purchase.'
//                 });
//                 // Redirect to QR code page
//                 // window.location.href = "/ticket-qr?orderId=" + orderData.id;
//                 window.location.href='/login'
//             } else {
//                 Swal.fire({
//                     icon: 'error',
//                     title: 'Payment verification failed!',
//                     text: 'Please try again later.'
//                 });
//             }
//         },
//         theme: { color: "#3399cc" }
//     };

//     const rzp1 = new Razorpay(options);
//     rzp1.open();
// };
document.getElementById("payBtn").onclick = async function () {
    const bookingData = {
        amount: <%= totalAmount %>,
        date: "<%= date %>",
        time: "<%= time %>",
        screen: "<%= screen %>",
        selectedSeats: <%- JSON.stringify(selectedSeats) %>
    };

    const orderData = await fetch("/create-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(bookingData)
    }).then(res => res.json());

    if (!orderData.id) {
        Swal.fire({
            icon: 'error',
            title: 'Failed to create Razorpay order',
            text: 'Please try again later.'
        });
        return;
    }

    const options = {
        key: "<%= razorpayKeyId %>",
        amount: orderData.amount,
        currency: "INR",
        name: "Your Cinema",
        description: "Ticket Payment",
        order_id: orderData.id,
        handler: async function (response) {
            const verifyRes = await fetch("/verify-payment", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(response)
            }).then(res => res.json());

            if (verifyRes.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Payment successful!',
                    text: 'Thank you for your purchase, your ticket is stored in my orders'
                });
                // window.location.href = '/ticket-qr?orderId=' + orderData.id;
                // window.location.href = '/ticket-qr?orderId=' + orderData.id;

            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Payment verification failed!',
                    text: 'Please try again later.'
                });
            }
        },
        theme: { color: "#3399cc" }
    };

    const rzp1 = new Razorpay(options);
    rzp1.open();
};


</script>

</body>
</html>